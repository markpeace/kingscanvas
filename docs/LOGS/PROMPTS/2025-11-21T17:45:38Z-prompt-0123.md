---
id: prompt-0123
epoch: 0010-prompt-refinement
issued_at: 2025-11-21T17:45:38Z
accepted_at: 2025-11-21T17:45:38Z
completed_at: 2025-11-21T17:46:34Z
status: completed
branch: work
pr: 25
validation_checks:
  - command: npm test -- --runInBand test/api/ai.suggest-steps.test.ts
    outcome: passed
    notes: Ran suggest-steps API tests with mocked workflow responses.
  - command: |
      python - <<'PY'
      import json
      import pathlib
      import yaml
      from jsonschema import validate

      schema = json.loads(pathlib.Path('docs/SCHEMA/pr-log.schema.json').read_text())
      pr_log = yaml.safe_load(pathlib.Path('docs/LOGS/PRS/pr-0025-pr-1c-hotfix-llm-server-only.md').read_text())

      validate(instance=pr_log, schema=schema)
      print('PR log passes schema validation.')
      PY
    outcome: passed
    notes: Validated PR log against the pr-log schema using PyYAML and jsonschema.
  - command: |
      python - <<'PY'
      import json
      import pathlib
      import yaml
      from jsonschema import validate

      schema = json.loads(pathlib.Path('docs/SCHEMA/prompt.schema.json').read_text())

      for path in [
          pathlib.Path('docs/LOGS/PROMPTS/2025-11-21T10:46:52Z-prompt-0120.md'),
          pathlib.Path('docs/LOGS/PROMPTS/2025-11-21T17:45:38Z-prompt-0123.md'),
      ]:
          documents = list(yaml.safe_load_all(path.read_text()))
          front_matter = documents[0]
          validate(instance=front_matter, schema=schema)
          print(f'{path.name} passes prompt schema validation.')
      PY
    outcome: failed
    notes: Prompt schema expects full PromptPackage fields; current prompt logs use a simplified format and do not include all required keys.
---

Hotfix LLM env server enforcement and instrumentation

## Notes
- Removed client-visible model environment usage and enforced server-only LLM configuration in the AI client and suggest-steps route.
- Added server-safe debug instrumentation for model selection and prompt logging on the suggest-steps API.
- Follow-up actions:
  - Consider aligning prompt log front matter with prompt.schema.json if required in future work.

## Validation
- command: npm test -- --runInBand test/api/ai.suggest-steps.test.ts
  outcome: passed
  notes: Ran suggest-steps API tests with mocked workflow responses.
- command: |
    python - <<'PY'
    import json
    import pathlib
    import yaml
    from jsonschema import validate

    schema = json.loads(pathlib.Path('docs/SCHEMA/pr-log.schema.json').read_text())
    pr_log = yaml.safe_load(pathlib.Path('docs/LOGS/PRS/pr-0025-pr-1c-hotfix-llm-server-only.md').read_text())

    validate(instance=pr_log, schema=schema)
    print('PR log passes schema validation.')
    PY
  outcome: passed
  notes: Validated PR log against the pr-log schema using PyYAML and jsonschema.
- command: |
    python - <<'PY'
    import json
    import pathlib
    import yaml
    from jsonschema import validate

    schema = json.loads(pathlib.Path('docs/SCHEMA/prompt.schema.json').read_text())

    for path in [
        pathlib.Path('docs/LOGS/PROMPTS/2025-11-21T10:46:52Z-prompt-0120.md'),
        pathlib.Path('docs/LOGS/PROMPTS/2025-11-21T17:45:38Z-prompt-0123.md'),
    ]:
        documents = list(yaml.safe_load_all(path.read_text()))
        front_matter = documents[0]
        validate(instance=front_matter, schema=schema)
        print(f'{path.name} passes prompt schema validation.')
    PY
  outcome: failed
  notes: Prompt schema expects full PromptPackage fields; current prompt logs use a simplified format and do not include all required keys.
